# Flakes

## Преговор

Миналата седмица си говорехме за NixOS, модули, overlays, направихме си една виртуална машина

## Нов проблем с възпроизводимостта

- Сега като имаме цяла система върху Nix откриваме дупка във възпроизводимостта
- Аз може да се оставя на по-стара версия на nixpkgs, докато друг да бъде на най-новата и може резултата който аз получавам при компилиране на една системна конфигурация да е различен от този на другия
- Винаги можем да пишем конфигурации които поддържат различни версии, но това е трудоемко и сложно
- И все пак остава проблема, че потребителя трябва сам да разбере и сложи коректната версия на nixpkgs

## flake

- Тук идват flake-овете, една сравнително нова идея спрямо възрастта на Nix
- Flake е attrset с три атрибута:
  - `description`, текстово описание
  - `inputs`, attrset с редица входни flake-ове (тук можем да поставим nixpkgs)
  - `outputs`, функция, получаваща всичките входове (като attrset от резултатни изрази) и връщаща attrset съдържащ резултатните nix изрази
- За всичките входове пазим един lock файл, съдържащ конкретните им версии
- Ако ги няма, теглим ги, като ги има, подаваме точно тези версии на `outputs`

---

- `inputs` не е задължително поле

### Пример на flake без вход

```
{
    description = "Some values";
    outputs = _: {
        x = 5; y = 10;
    };
}
```

## inputs

- Всеки вход си има име в attrset-а
- Входовете са attrset-ове, описващи от къде произлиза; има няколко формата

### URL

Най-простия формат

```
inputs.something.url = "git+https://github.com/NixOS/patchelf";
inputs.anything.url = "https://github.com/NixOS/patchelf/archive/master.tar.gz";
inputs.athing.url = "github:edolstra/nix-warez";
```

---

### Full attribute set

По-детайлния формат.
Само `type` е задължително, останалите атрибути зависят от него.
Някои възможни типове са `git`, `tarball`, `file`, `indirect`.

```
{
  type = "github";
  owner = "NixOS";
  repo = "nixpkgs";
}
```

## Създаване на флейкове

< ДЕМО където се създават флейкове; първо имаме онзи без inputs и създаваме втори чиито input е първия; второ правим с истински input-и, тоест nixpkgs и може би още някои проекти >

## NixOS чрез flakes

- Най-простият начин да превърнем системна конфигурация във flake е просто да добавим атрибут, чиято стойност е системната деривация
- По подразбиране това е под `nixosConfiguration."HOSTNAME"`
- Можем да "изкараме" самата деривация чрез `lib.nixosSystem`

---

### Примерен flake за система

```
{
  inputs.nixpkgs.url = "github:nixos/nixpkgs/nixos-24.11";
  outputs = { nixpkgs, ... }: {
    nixosConfiguration."mymach" = 
      nixpkgs.lib.nixosSystem = {
        system = "x86_64-linux";
        modules = [ ./configuration.nix ];
      };
  };
}
```

---

< ДЕМО >

## Други употреби

- Възможността да имаш пълна възпроизводимост е много удобна
- Можем да го използваме за произволни деривации
- Ако имаш `nix` инсталиран, единственото което ти трябва е flake-а на деривацията и всичко останало си се оправя
- От тук се появява "новата" `nix` команда

## nix командата

- Прилича на по-старите `nix-` команди, но всички се базира на употребата на flake-ове
- `nix build` вместо `nix-build`, където деривацията се взема от `outputs.package."SYSTEM"."NAME"`
- `nix develop` вместо `nix-shell`, където шел деривацията се взема от `outputs.devShells."SYSTEM"."NAME"`
- елиминираме нуждата от `nix-env`, `nix-channel`

< ДЕМО >

## outputs форматът

Както се вижда, имаме специални изисквания за атрибутите в `outputs`, за съответните команди

https://wiki.nixos.org/wiki/Flakes#Output_schema
