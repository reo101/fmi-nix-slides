# Nix пакетният мениджър

## Преговор

Миналата седмица си говорехме концептуално за разпространение на програми, пакетни мениджъри, Nix какви проблеми решава, инсталирахме го и го пролзвахме малко.

## Намираме се в междинен период

Класическите (версия 2) програми, които съставят пакетният мениджър са `nix-build`, `nix-shell`, `nix-env`, ...

От последните няколко години, те се заменят с аргументите на една единствена програма: `nix build`, `nix shell`, ...

Въпреки че имената си приличат, отдолу са напълно различни неща и другите аргументи които трябва да се подадат също се различават.

`nix` командата се основава на концепцията за flake-ове, но това е тема за средата на курса.

---

Обаче някои от `nix-` командите правят неща по твърде по-лош начин от `nix`, затова няма да разглеждаме всички.

Главната от тях е `nix-env`, тя на практика прави глобалното инсталиране (все пак по начин, който не пречи на други пакетни мениджъри), което се опитваме да избегнем от самото начало.

За жалост, някои документации като тази на Arch Linux представят `nix-env` като начинът да се използва Nix.

## Кратък увод в Nix езикът

Езикът чрез който дефинираме програми се казва **Nix**.

Не, името не е объркващо...

Типове данни, които ни интересуват за момента: числа (цели и дробни), низове (едноредови и многоредови), пътища, attrset, безименни функции.

---

```
2874
182.384
```

```
"single-line string"
''
muti
line
string
''
```

```
./files/image.jpeg
/usr/share/icon.png
```

---

```
{ a = 5; b = "Hello"; c = ./.; d = { m = 19.2; } }
{ x = 182; y = 192; }.x
```

```
var: var + 5
attrset_in: attrset_in.x * attrset_in.y
{ x, y, }: attrset_in.x * attrset_in.y
```

## Кратък увод в Nix пакети

Всеки "пакет" се нарича деривация.
Идва от основната функция която прави магията: `mkDerivation`.

Пакетът е редица от инструкции за това как дадена програма се компилира и инсталира.

За сега, важното е, че `mkDerivation` приема attrset с някакви конкретни атрибути.

Няма да разглеждаме `mkDerivation`, а само някои [trivial builders](https://ryantm.github.io/nixpkgs/builders/trivial-builders/)

## nix-build

Компилира nix пакет в ./result

<ДЕМО с някои тривиални builder-и, примерно runCommand и writeTextFile; добавяме някакви зависимости и композирания, примерно където имаме някакви зависимости които са файлове на деривацията и показваме string interpolation>

## nix-shell

Понякога се нуждаем да дебъгнем копмилационния процес или просто да тестваме някакви команди в средата на компилация.

`nix-shell` ни дава точно това: шел с всички зависимости и променливи настроени както ще бъдат по време на `nix-build`.

Можем да пускаме каквито си искаме команди.

Допълнително, можем да го използваме за conveinence, да създадем деривация в която само определяме неща за `nix-shell`.
Това става чрез `mkShell`.

<ДЕМО на предходните програми как влизаме и бараме; на mkShell>

## nix-store

`nix-store` е примитивната команда, която менижира всичко в `nix-store`.

На практика рядко трябва да я използваме, но е релевантно да знаем какво прави.

< обяснение на по-значими флагове и ДЕМО >

## nix-collect-garbage

Удобство над `nix-store --gc`.
Позволява да изтрием неща, които не ни трябват.

Когато се направи `nix-shell -p PACKAGE`, `PACKAGE` се добавя в `/nix/store`, обаче след като излезем от шел-а няма да се изтрие.
Би било твърде неудобно ако искаме същият шел след 5 минути и да трябва да инсталираме отново.

Затова Nix премахва неща само когато му кажеш, никога сам!

---

Сама по себе си, тази команда трие точно тези програми: инсталирани, обаче не са зависимост на нещо, което сме казали, че трябва да стои.
