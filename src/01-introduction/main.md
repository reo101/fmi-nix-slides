---
title: Идеи, концепции и история на Nix
date:
---

# Проблеми при дистрибуцията на софтуер

## Стъпки при добавянето на нов софтуер

- Трябва да инсталираш програмата **и** зависимостите ѝ

- Програми/библиотеки се инсталират на редица **глобални** локации: `/lib`, `/bin`, `C:\Program Files`, `/Applications`, ...

- Конфигурации се инсталират на редица **глобални** (спрямо потребителя) локации: `/etc`, `~/.config`, `%APPDATA%`, ...

## Ограничения

1. Трудно инсталираме повече от една версия на програма **или** зависимост.

   Възможно е две програми да ползват различи версии на зависимости!

2. Инсталирането/употребата на нови програми зависи от глобалната среда.

   Тоест зависи от файловата система, мрежата, ...

3. При премахването на програма първо трябва да знаем къде е инсталирана, второ трябва да премахнем само не-споделените зависимости.

4. Трябва да избираме само програми които се поддържат от процесорната архитектура, ОС, ...

## Пакетни мениджъри

- 3\. и 4. се разрешават чрез "пакетни мениджъри"

- Даваш им редица адреси в които да търсят програми.  
  Казваш им какво искаш да инсталираш.

- Те автоматично избират подходящите програми и зависимости за коректната архитектура/ОС/..., следят къде и какво се инсталира.

- Не предоставят решения за останалите проблеми

# Възможни решения за проблеми 1. и 2.

## Инсталиране на повече от една версия на програма

- Всяка програма се съхрнява в **уникална** директория, спрямо името и версията си

- Вместо да поставим `gcc` в `/bin`, поставяме го в `/somewhere/gcc-13.0.0`

## Инсталиране зависи от глобалната среда

- Съдаваме локална среда: временно "презаписваме" глобалните стойности и правим промени по програмата, когато това не е достатъчно

- Примерно, програмата иска `/bin/gcc`, даваме ѝ `/somewhere/gcc-13.0.0`

---

- Пакетните мениджъри решават последните два проблема.

- Тези идеи биха разрешили първите два.

- Не можем ли да разработим пакетен мениджър, който реализира тези схеми?

- Можем! Даже вече е създадено...

# Nix пакетният мениджър

- Преди >20 години Eelco Dolstra описва всички тези проблеми, решения и начинът да се реализират.
Резултатният пакетен мениджър кръстил **Nix**.

- Първоначалните идеи/имплементации са започнали през 2002-2003.

- Теорията кулминира в докторската му дисертацията през 2006, но разработката не спира до там.

- Версия 1.0 на пакетния мениджър е излязла през 2012.

- Версия 2.0 през 2018.

- Версия 3.0 през 2030?

## Реализации на идеите

- Бинарките идват с много препядствия: статични/динамични библиотеки, пътища във файловата система, ...

- Нека да компилираме всяка програма от изходния ѝ код (ще се върнем към това решение).

  *Има много програми, чиито код не е достъпен.
  За тях трябва изпълнимия файл да се променя.
  С изключението на по-основни програми, тези промени стават непоносимо сложни за оправяне.*

- Поставянето на програми под `/somewhere` става тривиално

- Строенето на локални среди е трудно

# Как създаваме локални среди?

## Локална спрямо файловата система

- За файловата система може да използваме `chroot`, но това не върши работа по време на изпълнение

- Закърпваме кодът, така че всяко срещане на `/bin/gcc` да се замени с `/somewhere/gcc-13.0.0`

- Оправя програмата, но не и нейният компилатор.
  Все още може да извършва статични/динамични връзки чрез неща в `/lib`.

- Трябва да сме създали компилаторът в локална среда.
  Но какво става с компилаторът на компилаторът?

---

- Няма решение, първото компилирано нещо в локалната среда се нуждае от зависимости в глобалната!

- Компромис: използваме бинарки и patchElf

- В изпълними файлове не можем лесно да заменим статично-свързани зависимости, но динамично-свързаните се свеждат до низови пътища.  
  [patchElf](https://github.com/NixOS/patchelf) прави промяната на тези пътища лесна.

---

За първата локална среда:

1. Използваме компилатор и неговите зависимости, компилирани в обикновенна система **само чрез динамични връзки**
2. Слагаме ги в директории под `/somewhere`
3. Пускаме patchElf да промени пътищата към динамичните връзки да сочат към `/somewhere`
4. Използваме тази среда, за да компилираме всички тези базови програми
5. Заменяме временните изпълними файлове с коректните

## Локална спрямо мрежата

- Другият голям компонент от глобалната среда е мрежата

- Освен сорс-код, често се нуждаем от допълнителни ресурси като докер контейнери

- Не е сигурно, че това което ще получим като изтеглим файлове от уеб адрес няма да се промени в бъдеще.

  Вместо очакваното може да получим грешка (добрия случай) или напълно различни данни (лошия случай).

---

- Няма как да задължим сайтовете!

- Компромис: проверяваме спрямо хешът на файла

- На първо теглене записваме хешът и в последователни правим сравнение.  
  При несъответствие хвърляме грешка.

- Понякога по време на компилиране може да се изтеглят ресурси.  
  Трябва и тях ние да си изтеглим, затова ще спрем интернетът в локалната среда.

## Възпроизводимост и кеширане

- Локалната среда, така както сме я създали, само може да компилира програми

- Това е бавен и натоварващ процес.
  За цяла система може да отнеме дни!

- Имаме спасение: възпроизводимост

- Ако локалната среда е напълно еднаква при всяко компилиране, тогава ще можем да преизползваме резултата!

  **Тоест, ако някой има бинарка, която е създадена в същата локална среда, като тази която ние бихме използвали, може просто да копираме техния резултат!**

---

- Как по-точно правим проверката?

- Създаваме хеш от всички входове, конфигурацията на средата и версията на Nix

- Обаче не сме готови, локалната ни среда все още не е 100% възпроизводима

- В нея ще променяме и потребителското име, датата, времевата зона, (root) директорията, ...

---

- Преизползването на резултатът наричаме "кеширане"

- Кешове с прекомпилирани програми за редица архитектури се поддържат Nix общността и употребата им е автоматична

- **На практика, почти никога не е нужно да компилираме програми, но получаваме всички ефекти от това да го правим!**

## Конкретики при Nix

`/something` всъщност е `/nix/store/`.

Всяка програма се идентифицира с хешът, името и версията.

# Нека да го пробваме

## Инсталация

### Linux/Windows (WSL)

```bash
sh <(curl -L https://nixos.org/nix/install) --daemon
```

### MacOS

```bash
sh <(curl -L https://nixos.org/nix/install)
```
